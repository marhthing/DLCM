import React, { useState, useEffect } from 'react';
import { Clock, Users, Youtube, Settings, CheckCircle } from 'lucide-react';

// Main App Component
export default function ChurchAttendanceApp() {
  const [page, setPage] = useState('login');
  const [user, setUser] = useState(null);
  const [startTime, setStartTime] = useState(null);
  const [youtubeUrl, setYoutubeUrl] = useState('https://www.youtube.com/embed/CHANNEL_ID/live');
  const [attendanceRecords, setAttendanceRecords] = useState([]);
  
  // Login form state
  const [loginName, setLoginName] = useState('');
  const [loginEmail, setLoginEmail] = useState('');
  
  // Admin form state
  const [adminPassword, setAdminPassword] = useState('');
  const [newYoutubeUrl, setNewYoutubeUrl] = useState('');

  // Track viewing duration
  useEffect(() => {
    if (page === 'stream' && user && startTime) {
      const interval = setInterval(() => {
        const duration = Math.floor((Date.now() - startTime) / 1000);
        console.log(`${user.name} watching for ${duration} seconds`);
      }, 30000);

      const handleBeforeUnload = () => {
        const duration = Math.floor((Date.now() - startTime) / 1000);
        recordAttendance(user, duration);
      };

      window.addEventListener('beforeunload', handleBeforeUnload);

      return () => {
        clearInterval(interval);
        window.removeEventListener('beforeunload', handleBeforeUnload);
      };
    }
  }, [page, user, startTime]);

  const recordAttendance = (userData, duration) => {
    const record = {
      name: userData.name,
      email: userData.email,
      date: new Date().toLocaleDateString(),
      time: new Date().toLocaleTimeString(),
      duration: `${Math.floor(duration / 60)} mins ${duration % 60} secs`,
      timestamp: new Date().toISOString()
    };
    
    setAttendanceRecords(prev => [...prev, record]);
    console.log('Attendance recorded:', record);
  };

  const handleLogin = () => {
    if (!loginName || !loginEmail) {
      alert('Please fill in all fields');
      return;
    }
    
    const userData = {
      name: loginName,
      email: loginEmail
    };
    
    setUser(userData);
    setStartTime(Date.now());
    setPage('stream');
  };

  const handleAdminLogin = () => {
    if (adminPassword === 'admin123') {
      setPage('admin');
    } else {
      alert('Incorrect password');
    }
  };

  const handleUpdateUrl = () => {
    if (!newYoutubeUrl) {
      alert('Please enter a YouTube URL');
      return;
    }
    
    let embedUrl = newYoutubeUrl;
    if (newYoutubeUrl.includes('youtube.com/watch?v=')) {
      const videoId = newYoutubeUrl.split('v=')[1].split('&')[0];
      embedUrl = `https://www.youtube.com/embed/${videoId}`;
    } else if (newYoutubeUrl.includes('youtu.be/')) {
      const videoId = newYoutubeUrl.split('youtu.be/')[1].split('?')[0];
      embedUrl = `https://www.youtube.com/embed/${videoId}`;
    } else if (!newYoutubeUrl.includes('embed')) {
      embedUrl = `https://www.youtube.com/embed/${newYoutubeUrl}`;
    }
    
    setYoutubeUrl(embedUrl);
    alert('YouTube link updated successfully!');
  };

  const exportToCSV = () => {
    const headers = ['Name', 'Email', 'Date', 'Time', 'Duration'];
    const rows = attendanceRecords.map(r => [r.name, r.email, r.date, r.time, r.duration]);
    
    let csv = headers.join(',') + '\n';
    rows.forEach(row => {
      csv += row.join(',') + '\n';
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `attendance-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
  };

  // LOGIN PAGE
  if (page === 'login') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Youtube className="text-white" size={32} />
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Church Live Stream</h1>
            <p className="text-gray-600">Sign in to watch and record your attendance</p>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
              <input
                type="text"
                value={loginName}
                onChange={(e) => setLoginName(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                placeholder="Enter your name"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
              <input
                type="email"
                value={loginEmail}
                onChange={(e) => setLoginEmail(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                placeholder="your.email@example.com"
              />
            </div>

            <button
              onClick={handleLogin}
              className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
            >
              Join Live Stream
            </button>
          </div>

          <div className="mt-6 text-center">
            <button
              onClick={() => setPage('adminLogin')}
              className="text-sm text-indigo-600 hover:underline"
            >
              Admin Access
            </button>
          </div>
        </div>
      </div>
    );
  }

  // ADMIN LOGIN PAGE
  if (page === 'adminLogin') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl shadow-xl p-8 w-full max-w-md">
          <div className="text-center mb-8">
            <div className="bg-indigo-600 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
              <Settings className="text-white" size={32} />
            </div>
            <h1 className="text-3xl font-bold text-gray-800 mb-2">Admin Login</h1>
          </div>

          <div className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
              <input
                type="password"
                value={adminPassword}
                onChange={(e) => setAdminPassword(e.target.value)}
                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                placeholder="Enter admin password"
              />
            </div>

            <button
              onClick={handleAdminLogin}
              className="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition-colors"
            >
              Login
            </button>
          </div>

          <div className="mt-6 text-center">
            <button
              onClick={() => setPage('login')}
              className="text-sm text-indigo-600 hover:underline"
            >
              Back to Login
            </button>
          </div>
        </div>
      </div>
    );
  }

  // STREAM PAGE
  if (page === 'stream') {
    return (
      <div className="min-h-screen bg-gray-900">
        <div className="bg-gray-800 border-b border-gray-700 px-6 py-4">
          <div className="max-w-7xl mx-auto flex justify-between items-center">
            <div className="flex items-center gap-3">
              <CheckCircle className="text-green-500" size={24} />
              <div>
                <h2 className="text-white font-semibold">{user.name}</h2>
                <p className="text-gray-400 text-sm">{user.email}</p>
              </div>
            </div>
            <div className="flex items-center gap-2 text-gray-400">
              <Clock size={20} />
              <span className="text-sm">Attendance being recorded</span>
            </div>
          </div>
        </div>

        <div className="max-w-7xl mx-auto p-6">
          <div className="aspect-video bg-black rounded-lg overflow-hidden shadow-2xl">
            <iframe
              width="100%"
              height="100%"
              src={youtubeUrl}
              title="Church Live Stream"
              frameBorder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
              allowFullScreen
            ></iframe>
          </div>

          <div className="mt-6 bg-gray-800 rounded-lg p-6">
            <h3 className="text-white text-xl font-semibold mb-2">Welcome to the Service!</h3>
            <p className="text-gray-400">
              Your attendance is being tracked. Please keep this window open during the service.
              You can minimize but don't close the tab.
            </p>
          </div>
        </div>
      </div>
    );
  }

  // ADMIN PAGE
  if (page === 'admin') {
    return (
      <div className="min-h-screen bg-gray-50">
        <div className="bg-white shadow">
          <div className="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
            <h1 className="text-2xl font-bold text-gray-800">Admin Dashboard</h1>
            <button
              onClick={() => setPage('login')}
              className="text-indigo-600 hover:underline"
            >
              Logout
            </button>
          </div>
        </div>

        <div className="max-w-7xl mx-auto p-6 space-y-6">
          <div className="bg-white rounded-lg shadow p-6">
            <h2 className="text-xl font-semibold mb-4 flex items-center gap-2">
              <Youtube className="text-red-600" />
              Update YouTube Stream
            </h2>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">
                  YouTube URL (any format)
                </label>
                <input
                  type="text"
                  value={newYoutubeUrl}
                  onChange={(e) => setNewYoutubeUrl(e.target.value)}
                  className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"
                  placeholder="https://youtube.com/watch?v=... or CHANNEL_ID/live"
                />
                <p className="text-sm text-gray-500 mt-2">
                  Supports: youtube.com/watch?v=, youtu.be/, CHANNEL_ID/live, or embed URLs
                </p>
              </div>
              <button
                onClick={handleUpdateUrl}
                className="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700"
              >
                Update Stream URL
              </button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow p-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-semibold flex items-center gap-2">
                <Users className="text-indigo-600" />
                Attendance Records ({attendanceRecords.length})
              </h2>
              <button
                onClick={exportToCSV}
                className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm"
              >
                Export CSV
              </button>
            </div>

            {attendanceRecords.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No attendance records yet</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Name</th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Email</th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Date</th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Time</th>
                      <th className="px-4 py-3 text-left text-sm font-semibold text-gray-700">Duration</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {attendanceRecords.map((record, index) => (
                      <tr key={index} className="hover:bg-gray-50">
                        <td className="px-4 py-3 text-sm">{record.name}</td>
                        <td className="px-4 py-3 text-sm">{record.email}</td>
                        <td className="px-4 py-3 text-sm">{record.date}</td>
                        <td className="px-4 py-3 text-sm">{record.time}</td>
                        <td className="px-4 py-3 text-sm">{record.duration}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 className="font-semibold text-blue-900 mb-2">Setup Instructions</h3>
            <ul className="text-sm text-blue-800 space-y-2">
              <li>• Default admin password: <code className="bg-blue-100 px-2 py-1 rounded">admin123</code></li>
              <li>• For permanent live stream, use: <code className="bg-blue-100 px-2 py-1 rounded">CHANNEL_ID/live</code></li>
              <li>• Attendance is recorded when users close the tab or leave</li>
              <li>• Export data to CSV to upload to Google Sheets</li>
            </ul>
          </div>
        </div>
      </div>
    );
  }
}